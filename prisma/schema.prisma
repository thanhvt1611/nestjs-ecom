// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
  moduleFormat    = "cjs"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum OrderStatus {
  PENDING_CONFIRMATION
  PENDING_PICKUP
  PENDING_DELIVERY
  DELIVERED
  RETURNED
  CANCELLED
}

enum VerificationCodeType {
  REGISTER
  FORGOT_PASSWORD
}

enum UserStatus {
  ACTIVE
  BLOCKED
}

enum HTTPMethod {
  GET
  POST
  PUT
  DELETE
  PATCH
  OPTIONS
  HEAD
}

// Models
model Language {
  id   Int    @id @default(autoincrement())
  name String @db.VarChar(100)
  code String @unique @db.VarChar(10)

  createdById Int?  @map("created_by_id")
  updatedById Int?  @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  createdBy User? @relation("LanguageCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User? @relation("LanguageUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  userTranslations     UserTranslation[]
  productTranslations  ProductTranslation[]
  categoryTranslations CategoryTranslation[]
  brandTranslations    BrandTranslation[]

  @@map("languages")
}

model User {
  id          Int        @id @default(autoincrement())
  email       String     @unique @db.VarChar(255)
  name        String     @db.VarChar(255)
  password    String     @db.VarChar(500)
  phoneNumber String     @map("phone_number") @db.VarChar(20)
  avatar      String?    @db.VarChar(1000)
  totpSecret  String?    @map("totp_secret") @db.VarChar(1000)
  status      UserStatus @default(ACTIVE)
  roleId      Int        @map("role_id")

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  role      Role  @relation("UserRole", fields: [roleId], references: [id])
  createdBy User? @relation("UserCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User? @relation("UserUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  userTranslations UserTranslation[]
  cartItems        CartItem[]
  orders           Order[]           @relation("UserOrders")
  reviews          Review[]
  refreshTokens    RefreshToken[]
  messagesFrom     Message[]         @relation("MessageFrom")
  messagesTo       Message[]         @relation("MessageTo")

  // Self-referencing relations for audit fields
  usersCreated              User[]                 @relation("UserCreatedBy")
  usersUpdated              User[]                 @relation("UserUpdatedBy")
  languagesCreated          Language[]             @relation("LanguageCreatedBy")
  languagesUpdated          Language[]             @relation("LanguageUpdatedBy")
  userTranslationsCreated   UserTranslation[]      @relation("UserTranslationCreatedBy")
  userTranslationsUpdated   UserTranslation[]      @relation("UserTranslationUpdatedBy")
  permissionsCreated        Permission[]           @relation("PermissionCreatedBy")
  permissionsUpdated        Permission[]           @relation("PermissionUpdatedBy")
  rolesCreated              Role[]                 @relation("RoleCreatedBy")
  rolesUpdated              Role[]                 @relation("RoleUpdatedBy")
  productsCreated           Product[]              @relation("ProductCreatedBy")
  productsUpdated           Product[]              @relation("ProductUpdatedBy")
  productTranslationsCreated ProductTranslation[]  @relation("ProductTranslationCreatedBy")
  productTranslationsUpdated ProductTranslation[]  @relation("ProductTranslationUpdatedBy")
  categoriesCreated         Category[]             @relation("CategoryCreatedBy")
  categoriesUpdated         Category[]             @relation("CategoryUpdatedBy")
  categoryTranslationsCreated CategoryTranslation[] @relation("CategoryTranslationCreatedBy")
  categoryTranslationsUpdated CategoryTranslation[] @relation("CategoryTranslationUpdatedBy")
  variantsCreated           Variant[]              @relation("VariantCreatedBy")
  variantsUpdated           Variant[]              @relation("VariantUpdatedBy")
  variantOptionsCreated     VariantOption[]        @relation("VariantOptionCreatedBy")
  variantOptionsUpdated     VariantOption[]        @relation("VariantOptionUpdatedBy")
  skusCreated               SKU[]                  @relation("SKUCreatedBy")
  skusUpdated               SKU[]                  @relation("SKUUpdatedBy")
  brandsCreated             Brand[]                @relation("BrandCreatedBy")
  brandsUpdated             Brand[]                @relation("BrandUpdatedBy")
  brandTranslationsCreated  BrandTranslation[]     @relation("BrandTranslationCreatedBy")
  brandTranslationsUpdated  BrandTranslation[]     @relation("BrandTranslationUpdatedBy")
  ordersCreated             Order[]                @relation("OrderCreatedBy")
  ordersUpdated             Order[]                @relation("OrderUpdatedBy")

  @@map("users")
}

model UserTranslation {
  id          Int    @id @default(autoincrement())
  userId      Int    @map("user_id")
  languageId  Int    @map("language_id")
  address     String? @db.VarChar(500)
  description String? @db.Text

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user      User      @relation(fields: [userId], references: [id])
  language  Language  @relation(fields: [languageId], references: [id])
  createdBy User?     @relation("UserTranslationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User?     @relation("UserTranslationUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@map("user_translations")
}

model VerificationCode {
  id        Int                   @id @default(autoincrement())
  email     String                @db.VarChar(255)
  code      String                @db.VarChar(10)
  type      VerificationCodeType
  expiresAt DateTime              @map("expires_at")
  createdAt DateTime              @default(now()) @map("created_at")

  @@index([email, code, type])
  @@index([expiresAt])
  @@map("verification_codes")
}

model RefreshToken {
  token     String   @unique @db.VarChar(1000)
  userId    Int      @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([expiresAt])
  @@map("refresh_tokens")
}

model Permission {
  id          Int        @id @default(autoincrement())
  name        String     @db.VarChar(100)
  description String     @db.VarChar(500)
  path        String     @db.VarChar(255)
  method      HTTPMethod

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  createdBy User? @relation("PermissionCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User? @relation("PermissionUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  roles PermissionsRoles[]

  @@map("permissions")
}

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(100)
  description String  @db.VarChar(500)
  isActive    Boolean @default(true) @map("is_active")

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  createdBy User? @relation("RoleCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User? @relation("RoleUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  users       User[]             @relation("UserRole")
  permissions PermissionsRoles[]

  @@map("roles")
}

model Product {
  id           Int      @id @default(autoincrement())
  base_price   Float    @map("base_price")
  virtual_price Float   @map("virtual_price")
  brandId      Int      @map("brand_id")
  images       String[] @db.VarChar(500)

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  brand     Brand                @relation(fields: [brandId], references: [id])
  createdBy User?                @relation("ProductCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User?                @relation("ProductUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  translations ProductTranslation[]
  variants     Variant[]
  skus         SKU[]
  categories   ProductsCategories[]
  reviews      Review[]

  @@map("products")
}

model ProductTranslation {
  id          Int    @id @default(autoincrement())
  productId   Int    @map("product_id")
  languageId  Int    @map("language_id")
  name        String @db.VarChar(255)
  description String @db.Text

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  product   Product  @relation(fields: [productId], references: [id])
  language  Language @relation(fields: [languageId], references: [id])
  createdBy User?    @relation("ProductTranslationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User?    @relation("ProductTranslationUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@map("product_translations")
}

model Category {
  id               Int  @id @default(autoincrement())
  parentCategoryId Int? @map("parent_category_id")

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  parentCategory Category?  @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id], onDelete: SetNull)
  createdBy      User?      @relation("CategoryCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy      User?      @relation("CategoryUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  subCategories Category[]             @relation("CategoryHierarchy")
  translations  CategoryTranslation[]
  products      ProductsCategories[]

  @@map("categories")
}

model CategoryTranslation {
  id          Int    @id @default(autoincrement())
  categoryId  Int    @map("category_id")
  languageId  Int    @map("language_id")
  name        String @db.VarChar(255)
  description String @db.Text

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  category  Category @relation(fields: [categoryId], references: [id])
  language  Language @relation(fields: [languageId], references: [id])
  createdBy User?    @relation("CategoryTranslationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User?    @relation("CategoryTranslationUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@map("category_translations")
}

model Variant {
  id        Int    @id @default(autoincrement())
  name      String @db.VarChar(100)
  productId Int    @map("product_id")

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  product   Product         @relation(fields: [productId], references: [id])
  createdBy User?           @relation("VariantCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User?           @relation("VariantUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  options VariantOption[]

  @@map("variants")
}

model VariantOption {
  id        Int    @id @default(autoincrement())
  value     String @db.VarChar(100)
  variantId Int    @map("variant_id")

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  variant   Variant              @relation(fields: [variantId], references: [id])
  createdBy User?                @relation("VariantOptionCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User?                @relation("VariantOptionUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  skus SkusVariantOptions[]

  @@map("variant_options")
}

model SKU {
  id        Int      @id @default(autoincrement())
  value     String   @db.VarChar(100)
  price     Float
  stock     Int
  images    String[] @db.VarChar(500)
  productId Int      @map("product_id")

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  product   Product                @relation(fields: [productId], references: [id])
  createdBy User?                  @relation("SKUCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User?                  @relation("SKUUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  cartItems          CartItem[]
  variantOptions     SkusVariantOptions[]
  productSKUSnapshots ProductSKUSnapshot[]

  @@map("skus")
}

model Brand {
  id   Int    @id @default(autoincrement())
  logo String @db.VarChar(500)

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  createdBy User? @relation("BrandCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User? @relation("BrandUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  products     Product[]
  translations BrandTranslation[]

  @@map("brands")
}

model BrandTranslation {
  id          Int    @id @default(autoincrement())
  brandId     Int    @map("brand_id")
  languageId  Int    @map("language_id")
  name        String @db.VarChar(255)
  description String @db.Text

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  brand     Brand    @relation(fields: [brandId], references: [id])
  language  Language @relation(fields: [languageId], references: [id])
  createdBy User?    @relation("BrandTranslationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User?    @relation("BrandTranslationUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@map("brand_translations")
}

model CartItem {
  id       Int @id @default(autoincrement())
  quantity Int
  skuId    Int @map("sku_id")
  userId   Int @map("user_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  sku  SKU  @relation(fields: [skuId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@map("cart_items")
}

model Order {
  id     Int         @id @default(autoincrement())
  userId Int         @map("user_id")
  status OrderStatus @default(PENDING_CONFIRMATION)

  createdById Int?      @map("created_by_id")
  updatedById Int?      @map("updated_by_id")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user      User  @relation("UserOrders", fields: [userId], references: [id])
  createdBy User? @relation("OrderCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User? @relation("OrderUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  productSKUSnapshots ProductSKUSnapshot[]

  @@map("orders")
}

model ProductSKUSnapshot {
  id          Int      @id @default(autoincrement())
  productName String   @db.VarChar(255)
  price       Float
  images      String[] @db.VarChar(500)
  skuValue    String   @map("sku_value") @db.VarChar(100)
  skuId       Int      @map("sku_id")
  orderId     Int      @map("order_id")

  createdAt DateTime @default(now()) @map("created_at")

  order Order @relation(fields: [orderId], references: [id])
  sku   SKU   @relation(fields: [skuId], references: [id])

  @@map("product_sku_snapshots")
}

model Review {
  id        Int    @id @default(autoincrement())
  content   String @db.Text
  rating    Int
  productId Int    @map("product_id")
  userId    Int    @map("user_id")

  deletedAt DateTime? @map("deleted_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  product Product @relation(fields: [productId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@map("reviews")
}

model Message {
  id         Int    @id @default(autoincrement())
  fromUserId Int    @map("from_user_id")
  toUserId   Int    @map("to_user_id")
  content    String @db.Text

  readAt    DateTime? @map("read_at")
  createdAt DateTime  @default(now()) @map("created_at")

  fromUser User @relation("MessageFrom", fields: [fromUserId], references: [id])
  toUser   User @relation("MessageTo", fields: [toUserId], references: [id])

  @@map("messages")
}

// Junction Tables
model PermissionsRoles {
  permissionId Int @map("permission_id")
  roleId       Int @map("role_id")

  permission Permission @relation(fields: [permissionId], references: [id])
  role       Role       @relation(fields: [roleId], references: [id])

  @@id([permissionId, roleId])
  @@map("permissions_roles")
}

model ProductsCategories {
  productId  Int @map("product_id")
  categoryId Int @map("category_id")

  product  Product  @relation(fields: [productId], references: [id])
  category Category @relation(fields: [categoryId], references: [id])

  @@id([productId, categoryId])
  @@map("products_categories")
}

model SkusVariantOptions {
  skuId           Int @map("sku_id")
  variantOptionId Int @map("variant_option_id")

  sku           SKU           @relation(fields: [skuId], references: [id])
  variantOption VariantOption @relation(fields: [variantOptionId], references: [id])

  @@id([skuId, variantOptionId])
  @@map("skus_variant_options")
}
